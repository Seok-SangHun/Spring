<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.app.mybatis.mapper.ReplyMapper">

    <!-- 댓글 작성 -->
    <insert id="insertReply">
        INSERT INTO TBL_REPLY (ID, REPLY_CONTENT, GROUP_ID, REPLY_DEPTH, CREATED_DATE, MEMBER_ID, STATUS)
        VALUES (SEQ_REPLY.NEXTVAL, #{replyContent}, NULL, 0, SYSDATE, #{memberId}, 1)
    </insert>

    <!-- 대댓글 작성 -->
    <insert id="insertReplyToComment">
        INSERT INTO TBL_REPLY (ID, REPLY_CONTENT, GROUP_ID, REPLY_DEPTH, CREATED_DATE, MEMBER_ID, STATUS)
        VALUES (SEQ_REPLY.NEXTVAL, #{replyContent}, #{groupId}, #{replyDepth}, SYSDATE, #{memberId}, 1)
    </insert>

    <select id="selectById" resultType="ReplyDTO">
        SELECT R.ID, R.REPLY_CONTENT, R.GROUP_ID, R.REPLY_DEPTH, R.CREATED_DATE, R.STATUS,
               M.MEMBER_NAME, M.MEMBER_AGE, M.MEMBER_EMAIL
        FROM TBL_MEMBER M JOIN TBL_REPLY R
                               ON M.ID = R.MEMBER_ID
        AND R.ID = #{id} AND R.STATUS = 1
        ORDER BY R. CREATED_DATE DESC
    </select>
    <!-- 댓글 목록 조회 (최상위 댓글) -->
    <select id="selectAllComments" resultType="ReplyDTO">
        SELECT R.ID, R.REPLY_CONTENT, R.GROUP_ID, R.REPLY_DEPTH, R.CREATED_DATE, R.STATUS,
               M.MEMBER_NAME, M.MEMBER_AGE, M.MEMBER_EMAIL
        FROM TBL_MEMBER M JOIN TBL_REPLY R
        ON M.ID = R.MEMBER_ID
        WHERE GROUP_ID IS NULL
          AND R.STATUS = 1
        ORDER BY R. CREATED_DATE DESC
    </select>

    <!-- 특정 댓글에 대한 대댓글 목록 조회 -->
    <select id="selectRepliesByGroupId" resultType="ReplyDTO">
        SELECT R.ID, R.REPLY_CONTENT, R.GROUP_ID, R.REPLY_DEPTH, R.CREATED_DATE, R.UPDATED_DATE, R.STATUS, R.MEMBER_ID,
               M.MEMBER_NAME, M.MEMBER_AGE, M.MEMBER_EMAIL
        FROM TBL_MEMBER M JOIN TBL_REPLY R
        ON M.ID = R.MEMBER_ID
        WHERE GROUP_ID = #{groupId}
          AND R.STATUS = 1
        ORDER BY CREATED_DATE DESC
    </select>

    <!-- 댓글 수정 -->
    <update id="updateReply">
        UPDATE TBL_REPLY
        SET REPLY_CONTENT = #{replyContent}, UPDATED_DATE = SYSDATE
        WHERE ID = #{id}
          AND STATUS = 1
    </update>

    <!-- 댓글 삭제 (논리 삭제) -->
    <update id="deleteReply">
        UPDATE TBL_REPLY
        SET STATUS = 0, UPDATED_DATE = SYSDATE
        WHERE ID = #{id}
    </update>

</mapper>
